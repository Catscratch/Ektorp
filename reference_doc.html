<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.1 from src/site/asciidoc/reference_doc.adoc at 2019-10-15

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.1" />
    <title>Ektorp &#x2013; </title>
    <link rel="stylesheet" href="./css/maven-base.css" />
    <link rel="stylesheet" href="./css/maven-theme.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<div id="bannerLeft">Ektorp
</div>
<a href="https://github.com/triplem/Ektorp/tree/v1.6" id="bannerRight"><img src=""  alt="Ektorp"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2019-10-15</span>
          &#xA0;| <span id="projectVersion">Version: 2.0.0-SNAPSHOT</span>
          | <a href="http://maven.apache.org/doxia/index.html" class="externalLink" title="Ektorp">Ektorp</a> &gt;

      </div>
      <div class="xright">      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Overview</h5>
    <ul>
     <li class="none"><a href="index.html" title="Introduction">Introduction</a></li>
     <li class="none"><strong>Reference Docs</strong></li>
     <li class="none"><a href="tutorial.html" title="Tutorial">Tutorial</a></li>
     <li class="none"><a href="https://sonarcloud.io/dashboard?id=triplem_Ektorp" class="externalLink" title="Sonar">Sonar</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="project-info.html" title="Project Information">Project Information</a></li>
     <li class="collapsed"><a href="project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>Ektorp Reference Documentation</h1>
<div class="sect1">
<h2 id="overview_of_ektorp">1. Overview of Ektorp</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ektorp is a persistence API that uses <a href="http://couchdb.apache.org/">CouchDB</a> as storage engine.
The goal of Ektorp is to combine JPA (Java Persistence API) like functionality with the simplicity and flexibility that CouchDB provides.</p>
</div>
<div class="sect2">
<h3 id="why_use_ektorp">1.1. Why Use Ektorp?</h3>
<div class="paragraph">
<p>Here are some good reasons why you should consider to use Ektorp in your project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Rich domain models.</em> With powerful JSON-object mapping provided by <a href="http://jackson.codehaus.org/">Jackson </a> it is easy to create rich domain models.</p>
</li>
<li>
<p><em>Schemaless comfort</em>. As CouchDB is schemaless, the database gets out of the way during application development. With a schemaless database, most adjustments to the database become transparent and automatic.</p>
</li>
<li>
<p><em>Out-of-the-Box CRUD</em>. The generic repository support makes it trivial to create persistence classes.</p>
</li>
<li>
<p>Convenient management of views through annotations.</p>
</li>
<li>
<p><em>API Coverage</em>. Ektorp has a broad coverage of the CouchDB API. You can perform most tasks like manage documents, perform queries, create, replicate and compact databases with the Ektorp API.</p>
</li>
<li>
<p><em>Active development</em>. Ektorp is actively developed and has a growing community.</p>
</li>
<li>
<p><em>Choice of abstraction level</em>. From full object-document mapping to raw streams, Ektorp will never stop you if you need to step down an abstraction level.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="obtaining_ektorp">2. Obtaining Ektorp</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="maven_artifacts">2.1. Maven Artifacts</h3>
<div class="sect3">
<h4 id="releases">2.1.1. Releases</h4>
<div class="paragraph">
<p>Core module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.ektorp<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>org.ektorp<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.3.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring support module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.ektorp<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>org.ektorp.spring<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.3.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="snapshots">2.1.2. Snapshots</h4>
<div class="paragraph">
<p>For the latest &amp; greatest use the snapshot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.ektorp<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>org.ektorp<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;version&gt;</span>2.0.0-SNAPSHOT<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>

 <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.ektorp<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>org.ektorp.spring<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;version&gt;</span>2.0.0-SNAPSHOT<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find the snapshots at <em><a href="http://oss.sonatype.org/content/repositories/snapshots/" class="bare">http://oss.sonatype.org/content/repositories/snapshots/</a></em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;repositories&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;repository&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;id&gt;</span>sonatype-nexus-snapshots<span style="color:#070;font-weight:bold">&lt;/id&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;url&gt;</span>http://oss.sonatype.org/content/repositories/snapshots/<span style="color:#070;font-weight:bold">&lt;/url&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;releases&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;enabled&gt;</span>false<span style="color:#070;font-weight:bold">&lt;/enabled&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;/releases&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;snapshots&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;enabled&gt;</span>true<span style="color:#070;font-weight:bold">&lt;/enabled&gt;</span>
      <span style="color:#070;font-weight:bold">&lt;/snapshots&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;/repository&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/repositories&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="download">2.2. Download</h3>
<div class="paragraph">
<p>Ektorp can be downloaded from <a href="https://github.com/helun/Ektorp/downloads">https://github.com/helun/Ektorp/downloads</a></p>
</div>
</div>
<div class="sect2">
<h3 id="sample_application">2.3. Sample Application</h3>
<div class="paragraph">
<p>A sample application can be downloaded from the Ektorp site.
It is a blog webapp aimed to showcase a basic Ektorp application.
You can read more about it in the <a href="https://helun.github.io/Ektorp/tutorial.html">Ektorp
          tutorial</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration">3. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CouchDB is represented by two main interfaces in Ektorp:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>org.ektorp.CouchDbInstance</em> is the handle for the actual CouchDB instance you are connecting to.</p>
</li>
<li>
<p><em>org.ektorp.CouchDbConnector</em> is a connection to a specific database residing on the instance above.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, in order to connect to a database in a CouchDB instance, you will need a CouchDbConnector, which needs a CouchDbInstance, which in turn needs a HttpClient.</p>
</div>
<div class="sect2">
<h3 id="httpclient">3.1. HttpClient</h3>
<div class="paragraph">
<p>Ektorp&#8217;s standard implementation of the HttpClient interface is <em>org.ektorp.http.StdHttpClient</em>.
It is created through a nested builder class: <em>StdHttpClient.Builder</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">HttpClient authenticatedHttpClient = <span style="color:#080;font-weight:bold">new</span> StdHttpClient?.Builder()
          .url(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://mychouchdbhost:5984</span><span style="color:#710">&quot;</span></span>)
          .username(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">admin</span><span style="color:#710">&quot;</span></span>)
          .password(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">secret</span><span style="color:#710">&quot;</span></span>)
          .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>StdHttpClient just wraps <a href="http://hc.apache.org/httpcomponents-client/index.html">Apache
        HttpClient
      </a> and exposes the following configuration properties:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. org.ektorp.http.StdHttpClient Config Parameters</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:5984" class="bare">http://localhost:5984</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">username</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxConnections</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connectionTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000 (ms)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">socketTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000 (ms)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">enableSSL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false (will automatically be enabled if url begins with
                https)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sslSocketFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JVM&#8217;s ssl socket factory will be used by
                default</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">relaxedSSLSettings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">caching</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxCacheEntries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxObjectSizeBytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8192</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">useExpectContinue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cleanupIdleConnections</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If this is not enough for you, you can always create a <em>org.apache.http.client.HttpClient</em> yourself and pass it as a constructor argument to the StdHttpClient.</p>
</div>
<div class="sect3">
<h4 id="enabling_ssl_tls_connections">3.1.1. Enabling SSL/TLS Connections</h4>
<div class="paragraph">
<p>If you want the http client to connector to CouchDB with a SSL/TLS connection, specify an url that begins with "https" or create the client with the parameter enableSSL = true.</p>
</div>
<div class="paragraph">
<p>You can bring your own SSLSocketFactory if you have configured special trust stores etc.
The factory can be specified through the sslSocketFactory parameter.</p>
</div>
<div class="paragraph">
<p>If you are lazy and want the trust manager to trust any host and certificate, relaxed SSL settings can be enabled through the relaxedSSLSettings parameter.</p>
</div>
</div>
<div class="sect3">
<h4 id="caching">3.1.2. Caching</h4>
<div class="paragraph">
<p>Caching is enabled by default.
This means that when you load a document from the database, it will be loaded from the http client&#8217;s cache if it exists in the cache and the revision has not changed since the last access.
This can speed up database access significantly.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="couchdbinstance">3.2. CouchDbInstance</h3>
<div class="paragraph">
<p>The standard implementation of the CouchDbInstance interface is <em>org.ektorp.impl.StdCouchDbInstance</em>.
This interface provides methods for managing databases on the connected CouchDb instance.</p>
</div>
<div class="paragraph">
<p>StdCouchDbInstance provides two constructors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>_StdCouchDbInstance(HttpClient client) _</p>
</li>
<li>
<p>_StdCouchDbInstance(HttpClient client, ObjectMapperFactory of) _</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The second constructor allows you to bring your own ObjectMapperFactory if you want full control on how Jackson is configured.</p>
</div>
<div class="paragraph">
<p><em>StdCouchDbInstance</em> is thread-safe.</p>
</div>
</div>
<div class="sect2">
<h3 id="couchdbconnector">3.3. CouchDbConnector</h3>
<div class="paragraph">
<p>The standard implementation of the CouchDbConnector interface is <em>org.ektorp.impl.StdCouchDbConnector</em>.
This interface provides methods for manipulating documents within a specific database.</p>
</div>
<div class="paragraph">
<p>StdCouchDbConnector provides two constructors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>StdCouchDbConnector(String databaseName, CouchDbInstance dbInstance)</p>
</li>
<li>
<p>StdCouchDbConnector(String databaseName, CouchDbInstance dbi, ObjectMapperFactory of)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The second constructor allows you to bring your own ObjectMapperFactory if you want full control on how Jackson is configured.</p>
</div>
<div class="paragraph">
<p><em>StdCouchDbConnector</em> is thread-safe.</p>
</div>
</div>
<div class="sect2">
<h3 id="a_minimal_configuration">3.4. A Minimal Configuration</h3>
<div class="paragraph">
<p>Here&#8217;s a minimal example configuration that connects to a CouchDB instance on localhost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.impl</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.http</span>.*;

...

  HttpClient httpClient = <span style="color:#080;font-weight:bold">new</span> StdHttpClient.Builder().build()
  CouchDbInstance dbInstance = <span style="color:#080;font-weight:bold">new</span> StdCouchDbInstance(httpClient);
  <span style="color:#777">// if the second parameter is true, the database will be created if it doesn't exists</span>
  CouchDbConnector db = dbInstance.createConnector(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_first_database</span><span style="color:#710">&quot;</span></span>, <span style="color:#069">true</span>);

  <span style="color:#777">// go!</span>
...</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistent_classes">4. Persistent Classes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ektorp can work with CouchDB documents in three different styles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>POJO (Plain Old Java Object)</p>
</li>
<li>
<p>java.util.Map&lt;String, Object&gt;</p>
</li>
<li>
<p>JsonNode - provides DOM-style access to JSON-documents</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="document_mapped_as_a_pojo">4.1. Document Mapped as a POJO</h3>
<div class="paragraph">
<p>Ektorp is mainly build for persisting rich domain classes in CouchDB much like classing ORM tools such as Hibernate.
This is achieved by using the powerful object mapping features provided by the Jackson JSON library.</p>
</div>
<div class="paragraph">
<p>Your classes need to fulfill two requirements in order to be compatible with Ektorp:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The class must be able to be serialized and deserialized through Jackson&#8217;s ObjectMapper.</p>
</li>
<li>
<p>The class must define an id field and a revision field through the annotations <em>@JsonProperty("_id")</em> and <em>@JsonProperty("_rev").</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here&#8217;s an example class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.codehaus.jackson.annotate</span>.*;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Sofa</span> {

  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> id;
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> revision;
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> color;

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_id</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getId() {
    <span style="color:#080;font-weight:bold">return</span> id;
  }

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_id</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setId(<span style="color:#0a8;font-weight:bold">String</span> s) {
    id = s;
  }

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_rev</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getRevision() {
    <span style="color:#080;font-weight:bold">return</span> revision;
  }

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_rev</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setRevision(<span style="color:#0a8;font-weight:bold">String</span> s) {
    revision = s;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setColor(<span style="color:#0a8;font-weight:bold">String</span> s) {
      color = s;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getColor() {
    <span style="color:#080;font-weight:bold">return</span> color;
  }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="non_standard_method_names">4.1.1. Non-standard Method Names</h4>
<div class="paragraph">
<p>It is possible to use other method names than shown above as long as the method is annotated with <em>@JsonProperty</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_id</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getIdentifikator() {
    <span style="color:#080;font-weight:bold">return</span> identifikator;
  }

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Methods can have any visibility; public, protected, default or private.</p>
</div>
</div>
<div class="sect3">
<h4 id="property_level_annotations">4.1.2. Property Level Annotations</h4>
<div class="paragraph">
<p>It is also possible to annotate the fields directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_id</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> id;

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_rev</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> rev;

...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the_couchdbdocument_support_class">4.1.3. The CouchDbDocument Support Class</h4>
<div class="paragraph">
<p>If you don&#8217;t mind dependencies on Ektorp in your domain classes you can extend the class <em>org.ektorp.support.CouchDbDocument</em></p>
</div>
<div class="paragraph">
<p>CouchDbDocument already has mappings defined for id, revision and also for attachment stubs.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how the Sofa class looks like when extending CouchDbDocument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.support.CouchDbDocument</span>;

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Sofa</span> <span style="color:#088;font-weight:bold">extends</span> CouchDbDocument{

  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> color;

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setColor(<span style="color:#0a8;font-weight:bold">String</span> s) {
    color = s;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getColor() {
    <span style="color:#080;font-weight:bold">return</span> color;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example_of_various_mappings">4.1.4. Example of Various Mappings</h4>
<div class="paragraph">
<p>Here is an example object that showcases various mappings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">org.ektorp.sample</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">java.util</span>.*;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.codehaus.jackson.annotate</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp</span>.*;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Sofa</span> <span style="color:#088;font-weight:bold">extends</span> CouchDbDocument {

  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> color;
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> seats;
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Date</span> dateCreated;
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; imageURLs;
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Pillow&gt; pillows;

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setColor(<span style="color:#0a8;font-weight:bold">String</span> s) {
    <span style="color:#950">this</span>.color = s;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> getSeats() {
    <span style="color:#080;font-weight:bold">return</span> seats;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setSeats(<span style="color:#339;font-weight:bold">int</span> i) {
    <span style="color:#950">this</span>.seats = i;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getColor() {
    <span style="color:#080;font-weight:bold">return</span> color;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; getImageURLs() {
    <span style="color:#080;font-weight:bold">return</span> imageURLs;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setImageURLs(<span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; imageURLs) {
    <span style="color:#950">this</span>.imageURLs = imageURLs;
  }

  <span style="color:#007">@JsonIgnore</span>
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> getNumberOfImages() {
    <span style="color:#080;font-weight:bold">return</span> imageURLs != <span style="color:#069">null</span> ? imageURLs.size() : <span style="color:#00D">0</span>;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Pillow&gt; getPillows() {
    <span style="color:#080;font-weight:bold">return</span> pillows;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setPillows(<span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Pillow&gt; pillows) {
    <span style="color:#950">this</span>.pillows = pillows;
  }

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">date_created</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Date</span> getDateCreated() {
    <span style="color:#080;font-weight:bold">return</span> dateCreated;
  }

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">date_created</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setDateCreated(<span style="color:#0a8;font-weight:bold">Date</span> dateCreated) {
    <span style="color:#950">this</span>.dateCreated = dateCreated;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, most properties does not require any special mappings.
The @JsonProperty annotation are used to map a property to a different name than the property name.</p>
</div>
<div class="paragraph">
<p>In order to suppress a property <em>@JsonIgnore</em> is used.</p>
</div>
</div>
<div class="sect3">
<h4 id="immutable_object">4.1.5. Immutable Object</h4>
<div class="paragraph">
<p>It is possible to map immutable objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">org.ektorp.sample</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.codehaus.jackson.annotate</span>.*;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Pillow</span> {

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">enum</span> Softness {SOFT, MEDIUM, FIRM}

  <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Softness softness;

  <span style="color:#007">@JsonCreator</span>
  <span style="color:#088;font-weight:bold">public</span> Pillow(<span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">softness</span><span style="color:#710">&quot;</span></span>) Softness s) {
    softness = s;
  }

  <span style="color:#088;font-weight:bold">public</span> Softness getSoftness() {
    <span style="color:#080;font-weight:bold">return</span> softness;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The constructor is annotated with <em>@JsonCreator</em> and the properties has to be specified with @JsonProperty</p>
</div>
</div>
<div class="sect3">
<h4 id="referring_other_documents">4.1.6. Referring Other Documents</h4>
<div class="paragraph">
<p>An embedded collection may need to be externalized due to size or to reduce update congestion.</p>
</div>
<div class="paragraph">
<p>Ektorp provides support for this through the @DocumentReferences annotation.</p>
</div>
<div class="paragraph">
<p>Fields annotated with @DocumentReferences will have their children elements stored in separate documents.
Only collections that implement java.util.Set are supported.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">BlogPost</span> {

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_id</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> id;

  <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_rev</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> rev;

  <span style="color:#007">@DocumentReferences</span>(backReference = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">blogPostId</span><span style="color:#710">&quot;</span></span>, fetch = FetchType.LAZY,
  descendingSortOrder = <span style="color:#069">true</span>, orderBy = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">dateCreated</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Comment&gt; comments;

  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The backReference parameter is required and must name the field in the child document that contains the id of the parent document.</p>
</div>
<div class="paragraph">
<p>The fetch strategy if @DocumentReferences collections may be lazy or eager.
If set to lazy, the collection will be populated in entirety when the collection is first touched.
Eager setting will cause the collection to be populated at the same time as it parent.</p>
</div>
<div class="paragraph">
<p>The sort order of the loaded collection may be specified by the orderBy parameter.
The parameter must refer to a field in the child docs.</p>
</div>
<div class="sect4">
<h5 id="transitive_persistence">Transitive Persistence</h5>
<div class="paragraph">
<p>If an element is added to a Set annotated with @DocumentReferences the element will be stored transparently when the parent document is updated.</p>
</div>
<div class="paragraph">
<p>Removing an element from the collection will cause its deletion from the database when the parent document is updated.</p>
</div>
<div class="paragraph">
<p>The cascade behaviour can be controlled through the cascade parameter in @DocumentReferences.
There are four cascade types:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All operations are cascaded to the child
                    documents.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAVE_UPDATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cascades the create and update operations when
                    create(), update(), executeBulk() or executeAllOrNothing()
                    is called.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cascades the remove operation to associated entities
                    if delete(), executeBulk() or executeAllOrNothing() is
                    called.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NONE (default)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No operation is cascaded to the child
                    documents.</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="recommendation">Recommendation</h6>
<div class="paragraph">
<p>The cascade type you choose can have a large inpact on how your application behaves.
If you have moved the collection to extenal documents in order to avoid update congestion, then cascade type NONE is probably the best option as this will minimize conflicts.</p>
</div>
</div>
<div class="sect5">
<h6 id="limitations">Limitations</h6>
<div class="paragraph">
<p>In Ektorp 1.1.0 the cascade logic for updates is quite crude and will cause updates of all elements, regardless if the have changed or not.
This behaviour might change in future releases.</p>
</div>
<div class="paragraph">
<p>If the parent document is deleted the child docuements will not be deleted automatically.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="supporting_views">Supporting Views</h5>
<div class="paragraph">
<p>Allthough the document references are managed transparently it can be interesting to know that the relations between parent and child documents are managed by views that are automatically generated by Ektorp (unless explicitly specified). These views are put in the <a href="std_design_doc">Standard Design
              Document
            </a> and are named according to the following naming convention: ektorp_docrefs_[fieldName].</p>
</div>
<div class="paragraph">
<p>Supporting views are generated in conjunction with the view generation functionaly provided by the repository support in Ektorp, see <a href="auto_view_gen">chapter 6</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="only_one_to_many_relations_are_supported">Only One-to-Many relations are supported</h5>
<div class="paragraph">
<p>The views can only support one backreference to one parent, Many-to-Many relations are hence not supported.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="decoupling_persistent_classes_from_annotations">4.1.7. Decoupling Persistent Classes from Annotations</h4>
<div class="paragraph">
<p>If you don&#8217;t want your classes to have external dependencies or if you can&#8217;t modify them for other reasons, you can register a mix-in class (or interface) that provides the mapping information to the JSON processor.
In order to do this you must bring your own instance of org.codehaus.jackson.map.ObjectMapper:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ObjectMapper myMapper = <span style="color:#080;font-weight:bold">new</span> ObjectMapper();

myMapper.getSerializationConfig().addMixInAnnotations(<span style="color:#0a8;font-weight:bold">Target</span>.class, MixIn.class);
myMapper.getDeserializationConfig().addMixInAnnotations(<span style="color:#0a8;font-weight:bold">Target</span>.class, MixIn.class);


CouchDbConnector db = <span style="color:#080;font-weight:bold">new</span> StdCouchDbConnector(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">myDBName</span><span style="color:#710">&quot;</span></span>, dbInstance, myMapper);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mix-in class is just an abstract class that provides the annotations for your target class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@JsonSerialize</span>(include = Inclusion.NON_NULL)
<span style="color:#088;font-weight:bold">abstract</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MixIn</span>

<span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_id</span><span style="color:#710">&quot;</span></span>) <span style="color:#088;font-weight:bold">abstract</span> <span style="color:#339;font-weight:bold">int</span> getFoo(); <span style="color:#777">// rename property</span>
<span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_rev</span><span style="color:#710">&quot;</span></span>) <span style="color:#088;font-weight:bold">abstract</span> <span style="color:#339;font-weight:bold">int</span> getBar(); <span style="color:#777">// rename property</span>
<span style="color:#007">@JsonIgnore</span> <span style="color:#339;font-weight:bold">int</span> getSize(); <span style="color:#777">// we don't need it!</span>

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read more about mix-ins in the <a href="http://wiki.fasterxml.com/JacksonMixInAnnotations">Jackson
            Documentation.
          </a></p>
</div>
</div>
<div class="sect3">
<h4 id="custom_serializer">4.1.8. Custom Serializer</h4>
<div class="paragraph">
<p>If you have special needs and want to have complete control of the serialization you can register a custom serializer for your class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@JsonSerailize</span>(using = MySpecialType.Serializer.class)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MySpecialDocument</span> {

  <span style="color:#0a8;font-weight:bold">String</span> id;
  <span style="color:#0a8;font-weight:bold">String</span> revision;

  ... rest of <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">goes</span> here ...

  public <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Serializer</span> <span style="color:#088;font-weight:bold">extends</span> JsonSerializer&lt;MySpecialType&gt; {

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> serialize(MySpecialType value, JsonGenerator jgen,
    SerializerProvider provider) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">IOException</span>,
    JsonProcessingException {
      jgen.writeStartObject();
      jgen.writeStringField(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_id</span><span style="color:#710">&quot;</span></span>, value.id);
      jgen.writeStringField(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_rev</span><span style="color:#710">&quot;</span></span>, value.revision);

      ...
      etc etc
      ...
      jgen.writeEndObject();
    }

  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="custom_documentaccessor">4.1.9. Custom DocumentAccessor</h4>
<div class="paragraph">
<p>Ektorp has to know how to access the id and revision properties in the types it is working with.
For most types that are annotated or follow the naming convention this works out of the box.
But if you are using a an exotic type, a custom serializer or mix-ins Ektorp might not be able to figure out how to access these properties.</p>
</div>
<div class="paragraph">
<p>In this case you can create and register a custom document accessor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.util.DocumentAccessor</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.util.Documents</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyDocumentAccessor</span> <span style="color:#088;font-weight:bold">implements</span> DocumentAccessor {
  <span style="color:#777">/**
  * @return true if document type's id field can be mutated.
  */</span>
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> hasIdMutator() {
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getId(<span style="color:#0a8;font-weight:bold">Object</span> o) {
    <span style="color:#080;font-weight:bold">return</span> cast(o).foo;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setId(<span style="color:#0a8;font-weight:bold">Object</span> o, <span style="color:#0a8;font-weight:bold">String</span> id) {
    cast(o).foo = rev;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getRevision(<span style="color:#0a8;font-weight:bold">Object</span> o) {
    <span style="color:#080;font-weight:bold">return</span> cast(o).bar;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setRevision(<span style="color:#0a8;font-weight:bold">Object</span> o, <span style="color:#0a8;font-weight:bold">String</span> rev) {
    cast(o).bar = rev;
  }

  <span style="color:#088;font-weight:bold">private</span> MyType cast(<span style="color:#0a8;font-weight:bold">Object</span> o) {
    <span style="color:#080;font-weight:bold">return</span> (MyType) o;
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And register the new accessor with Ektorp:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Documents.registerAccessor(MyType.class, <span style="color:#080;font-weight:bold">new</span> MyDocumentAccessor());

<span style="color:#777">// here's a Junit snippet you can use to test your accessor:</span>
MyType myType = <span style="color:#080;font-weight:bold">new</span> MyType();
Documents.setId(myType, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_id</span><span style="color:#710">&quot;</span></span>);
assertEquals(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_id</span><span style="color:#710">&quot;</span></span>, Documents.getId(myType));
assertTrue(Documents.isNew(myType));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="document_mapped_as_java_util_map">4.2. Document Mapped as java.util.Map</h3>
<div class="paragraph">
<p>It is possible to read and write documents mapped as java.util.Map&lt;String, Object&gt;. This is convenient if you have documents that have a simple structure and a small number of fields.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; countries = ...
Map&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; majorCitiesByCountry = ...

Map&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">Object</span>&gt; referenceData = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">Object</span>&gt;();
referenceData.put(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_id</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">referenceData</span><span style="color:#710">&quot;</span></span>);
referenceData.put(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">countries</span><span style="color:#710">&quot;</span></span>, countries);
referenceData.put(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">majorCitiesByCountry</span><span style="color:#710">&quot;</span></span>, majorCitiesByCountry);

db.create(referenceData);

<span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">Object</span>&gt; referenceData_2 = db.get(<span style="color:#0a8;font-weight:bold">Map</span>.class, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">referenceData</span><span style="color:#710">&quot;</span></span>)
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="document_mapped_as_jsonnode">4.3. Document Mapped as JsonNode</h3>
<div class="paragraph">
<p>If you like to work with your documents in a DOM-style manner your can use <em>org.codehaus.jackson.JsonNode</em>.
This is useful if you want to modify documents without creating explicit Java types for them.
JsonNode is more powerful than java.util.Map when it comes to traversing and modifying the document.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.codehaus.jackson</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.codehaus.jackson.node</span>.*;

...

  JsonNode doc = db.get(JsonNode.class, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">myDoc</span><span style="color:#710">&quot;</span></span>);

  JsonNode address = doc.findPath(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">address</span><span style="color:#710">&quot;</span></span>);
  <span style="color:#080;font-weight:bold">if</span> (address.isObject()) {
    ObjectNode a = (ObjectNode) address;
    a.put(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">city</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Stockholm</span><span style="color:#710">&quot;</span></span>);
  }

  db.update(doc);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="working_with_objects">5. Working with Objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Basic CRUD (Create, Read, Update and Delete) operations are straightforward in Ektorp.</p>
</div>
<div class="paragraph">
<p>The easiest way to create a repository is to extend the class CouchDbRepositorySupport.
The class provides all CRUD methods out of the box and has support methods for writing terse finder methods.</p>
</div>
<div class="sect2">
<h3 id="create">5.1. Create</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sofa sofa = ...

CouchDbConnector db = ...
db.create(sofa);

<span style="color:#777">// both id and revision will be set after create</span>
<span style="color:#0a8;font-weight:bold">String</span> id = sofa.getId();
<span style="color:#0a8;font-weight:bold">String</span> revision = sofa.getRevision();</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the object being created does not have an id set, CouchDB will generate one.
Both id and revision will be set after the create operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="read">5.2. Read</h3>
<div class="paragraph">
<p>Get the latest revision of a document from the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> id = ...
Sofa sofa = db.get(Sofa.class, id);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the desired document does not exists in the database an <em>org.ektorp.DocumentNotFoundException</em> is thrown.</p>
</div>
<div class="paragraph">
<p>If you need to fetch a specific revision:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> id = ...
String rev = ...
Sofa sofa = db.get(Sofa.class, id, rev);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read a document as a raw stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> id = ...
InputStream doc = db.getAsStream(id);

<span style="color:#0a8;font-weight:bold">InputStream</span> olderRev = db.getAsStream(id, rev);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="special_cases">5.2.1. Special Cases</h4>
<div class="paragraph">
<p>All get methods in CouchDbConnector has a variant that takes a <em>org.ektorp.Options</em> argument.
Options is used for special cases when you need to load a document with a specific revision, conflict markers etc.</p>
</div>
<div class="sect4">
<h5 id="read_a_specific_revision">Read a Specific Revision</h5>
<div class="paragraph">
<p><code class="parameter">Retrieve a specific revision of the
              document. </code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> id = ...
              String rev = ...
              Options options = <span style="color:#080;font-weight:bold">new</span> Options().revision(rev);
              Sofa sofa = db.get(Sofa.class, id, options);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="include_conflicts">Include Conflicts</h5>
<div class="paragraph">
<p>The loaded doc will include the special field '_conflicts' that contains all the conflicting revisions of the document.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> id = ...
Options options = <span style="color:#080;font-weight:bold">new</span> Options().includeConflicts();
Sofa sofa = db.get(Sofa.class, id, options);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="include_all_revisions">Include All Revisions</h5>
<div class="paragraph">
<p>The loaded doc will include the special field '_revisions' that describes all document revisions that exists in the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> id = ...
Options options = <span style="color:#080;font-weight:bold">new</span> Options().includeRevisions();
Sofa sofa = db.get(Sofa.class, id, options);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add_arbitrary_parameters_to_the_request">Add Arbitrary Parameters to the Request</h5>
<div class="paragraph">
<p><code class="parameter">It is possible to add arbitrary parameters to the
              database request. </code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> id = ...
              Options options = <span style="color:#080;font-weight:bold">new</span> Options().param(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">paramName</span><span style="color:#710">&quot;</span></span>,<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">paramValue</span><span style="color:#710">&quot;</span></span>);
              Sofa sofa = db.get(Sofa.class, id, options);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="update">5.3. Update</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sofa sofa = ...
db.update(sofa)
<span style="color:#777">// revision will be updated after update</span>
sofa.getRevision();</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the there exists a newer revision of the document in the database, an <em>org.ektorp.UpdateConflictException</em> is thrown.</p>
</div>
<div class="paragraph">
<p>Note that calling update with an object that has an empty id field will create a new document in the database.</p>
</div>
<div class="sect3">
<h4 id="updating_from_a_stream">5.3.1. Updating from a Stream</h4>
<div class="paragraph">
<p>Documents can be updated from an InputStream.
The InputStream must contain a JSON document.
Using an InputStream allows you to update a document from a JSON document without having to parse it, which can be more efficient for large documents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">File</span> file = someMethodToGetFile();
<span style="color:#0a8;font-weight:bold">InputStream</span> jsonInputStream = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">FileInputStream</span>(file);
db.update(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">document_id</span><span style="color:#710">&quot;</span></span>, jsonInputStream, file.length(), <span style="color:#069">null</span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="delete">5.4. Delete</h3>
<div class="paragraph">
<p>Both the id and revision of an object is required in order to delete it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> id = ...
String revision = ...
db.delete(id, revision):</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the there exists a newer revision of the document in the database, an <em>org.ektorp.UpdateConflictException</em> is thrown.</p>
</div>
<div class="paragraph">
<p>As a convenience, a whole object can also be passed as an argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sofa sofa = ...
db.delete(sofa)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="purge_deleted_documents">5.4.1. Purge Deleted Documents</h4>
<div class="paragraph">
<p>Since the database retains references to deleted documents you may need to permanently remove those references.
This can be achieved through a purge operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// the map contains revisions by doc id to purge
            Map&lt;String,List&lt;String&gt;&gt; revisionsToPurge = ...
            PurgeResult result = db.purge(revisionsToPurge);
----[parameter]``Note that purging docs from the database is not
            part of a normal use case and should only be considered if you need to
            free up disk space. ``

=== Bulk Operations

Ektorp provides full support for the bulk document operations available in CouchDB.

==== Fetch Multiple Documents With a Single Request

Loading multiple documents in one call is performed through the queryView API.
The difference from regular view queries is that allDocs() is called instead of defining a design document.

[source,java]</code></pre>
</div>
</div>
<div class="paragraph">
<p>List&lt;String&gt; docIds = &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>ViewQuery q = new ViewQuery()
  .allDocs()
  .includeDocs(true)
  .keys(docIds);</p>
</div>
<div class="paragraph">
<p>List&lt;Sofa&gt; bulkLoaded = db.queryView(q, Sofa.class);</p>
</div>
<div class="listingblock">
<div class="content">
<pre>==== Creating, Updating and Deleting Documents With a SingleRequest

All other bulk operations are performed through the same methods in __CouchDbConnector__:

[source,java]</pre>
</div>
</div>
<div class="paragraph">
<p>List&lt;DocumentOperationResult&gt; executeBulk(Collection&lt;?&gt; objects);</p>
</div>
<div class="paragraph">
<p>List&lt;DocumentOperationResult&gt; executeAllOrNothing(Collection&lt;?&gt; objects);</p>
</div>
<div class="listingblock">
<div class="content">
<pre>If a new object is added to the objects list it will be created in the database.
If an existing object is added, (revision being not null) it will be updated.

In order to delete an object, add a instance of org.ektorp.BulkDeleteDocument the the bulk list:

[source,java]</pre>
</div>
</div>
<div class="paragraph">
<p>List&lt;Object&gt; bulkDocs = &#8230;&#8203;
Sofa toBeDeleted = &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>bulkDocs.add(BulkDeleteDocument.of(toBeDeleted));</p>
</div>
<div class="paragraph">
<p>db.executeBulk(bulkDocs);</p>
</div>
<div class="listingblock">
<div class="content">
<pre>==== All Or Nothing

The method _executeAllOrNothing_ has unsurprisingly all-or-nothing semantics.
In the case of a failure during the bulk operation, when the database restarts either all the changes will have been saved or none of them.
However, it does not do any conflict checking, so the documents will be committed even if this creates conflicts.

==== A Note on Resource Usage in Bulk Operations

Ektorp will create threads for writing bulk documents to the database.
The threads are named __"ektorp-doc-writer-[thread
            count]"__.
The thread pool used is a __java.util.concurrent.Executors.newCachedThreadPool()__.
Unused threads will die after 60 seconds.

== Repository Support

The Repository Support in Ektorp is aimed to reduce the amount of repetitive code in repositories and to facilitate the management of the design documents that define the views for the documents in CouchDB.

Ektorp provides a repository base class _org.ektorp.support.CouchDbRepositorySupport_ that has a number of features:

* Out of the box CRUD.
* Automatic view generation.
* View management.
* Support methods for easier querying.


=== Out of the Box CRUD

Here is a minimal repository based on _org.ektorp.support.CouchDbRepositorySupport:_

[source,java]</pre>
</div>
</div>
<div class="paragraph">
<p>package org.ektorp.sample;</p>
</div>
<div class="paragraph">
<p>import java.util.<strong>;
import org.ektorp.</strong>;</p>
</div>
<div class="paragraph">
<p>public class SofaRepository extends CouchDbRepositorySupport&lt;Sofa&gt; {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>public SofaRepository(CouchDbConnector db) {
  super(Sofa.class, db);
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>  public List&lt;Sofa&gt; findByColor(String color) {
    return queryView("by_color", color);
  }
}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>This repository above doesn't look like much but _CouchDbRepositorySupport_ has provided the following methods to the SofaRepository:

[source,java]</pre>
</div>
</div>
<div class="paragraph">
<p>public void add(Sofa entity);
public void update(Sofa entity);
public void remove(Sofa entity);
public Sofa get(String id);
public Sofa get(String id, String rev);
public List&lt;T&gt; getAll();
public boolean contains(String docId);</p>
</div>
<div class="listingblock">
<div class="content">
<pre>=== Standard Design Document

When using support methods like _queryView_ the underlying code assumes that the database contains a design document with an id adhering to the naming convention:

_\_design/[repository type simple name]_

e.g.
the repository in the previous section expects that the document _design/Sofa exists in the database.

Calling _queryView_ without the standard design document defined will cause an exception to be thrown.

==== Standard Views

The method getAll will try to query the view "all" in the standard design document in order to get a list of all document ids that are handled by the repository.

If the "all" view is missing, all documents (except design documents) will be loaded.
This means that you cannot mix document types in the same database without the "all" view.
Another problem with a missing "all" view is that concurrent deletes of documents while documents are loaded may cause an DbAccessException.

It is strongly recommended that the all view is defined in a production enviroment.

Here is an example "all" view:

[source,javascript]</pre>
</div>
</div>
<div class="paragraph">
<p>[{"_id":"_design/Sofa",
          "views":{
          "all": {"map": "function(doc) { if (doc.type == 'Sofa' ) emit( null, doc._id ) } "}
          }
          }]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>=== In-line View Definitions

Repositories based on CouchDbRepositorySupport may define the views used by the repository through annotations in the repository class.

[source,java]</pre>
</div>
</div>
<div class="paragraph">
<p>@View( name = "all", map = "function(doc) { if (doc.type ==
        'Sofa' ) emit( null, doc._id )}")
        public class SofaRepository extends CouchDbRepositorySupport&lt;Sofa&gt; {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@View( name = "avg_sofa_size", map = "function(doc) {...}", reduce = "function(doc) {...}")
public int getAverageSofaSize() {
ViewResult r = db.queryView(createQuery("avg_sofa_size"));
return r.getRows().get(0).getValueAsInt();
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>If you have many view definition you can group them with the @Views annotation:

[source]</pre>
</div>
</div>
<div class="paragraph">
<p>@Views({
        @View(name = "view_1", map = "function(doc) { &#8230;&#8203; }"),
        @View(name = "view_2", map = "function(doc) { &#8230;&#8203; }"),
        @View(name = "view_3", map = "function(doc) { &#8230;&#8203; }")
        })
        public class MyRepository {
        &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>_@View_ and _@Views_ and can be defined at class level or at method level.

View creation is triggered by calling the method: _initStandardDesignDocument_ in __CouchDbRepositorySupport__.

If the standard design document doesn't exists, it will be created.

==== Loading the View Definition From the classpath

Non-trivial views are best stored in a separate files.
By specifying the "classpath:" prefix in the map or reduce parameters, followed by the path to a file in the classpath, the functions can be loaded from the classpath.
The path is relative to the class annotated by this annotation.
If the file myMapFunction.js is in the same directory as the repository this parameter should be set to __"myMapFunction.js"__:

[source,javascript]</pre>
</div>
</div>
<div class="paragraph">
<p>function(doc)
          {
          much javascript here
          }</p>
</div>
<div class="listingblock">
<div class="content">
<pre>The repository class:

[source,java]</pre>
</div>
</div>
<div class="paragraph">
<p>@View( name = "complicated_view", map =
          "classpath:myMapFunction.js")
          public int getAverageSofaSize() {
          ViewResult r = db.queryView(createQuery("complicated_view.json"));
          return r.getRows().get(0).getValueAsInt();
          }</p>
</div>
<div class="listingblock">
<div class="content">
<pre>==== Auto Updating Views

The default behaviour is to not touch existing views if they already exists.
However, Ektorp can update views automatically if the view defined in the annotation @View differs from the one existing in the database.
This is especially convenient during development.

This feature is enabled through the system property: _org.ektorp.support.AutoUpdateViewOnChange=true_

If enabled, a simple string comparison will determine if the view definition has changed and update it if necessary.

If you are using the Ektorp Spring module, you can also enable this feature through a setter in __org.ektorp.spring.HttpClientFactoryBean__.

=== Automatic Generation of Design Documentand Views

_CouchDbRepositorySupport_ is able to generate some views automatically.
Simple finder methods can be annotated with the _@GenererateView_ annotation.

[source,java]</pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;
        @GenerateView
        public List&lt;Sofa&gt; findByColor(String color) {
        return queryView("by_color", color);
        }
        &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>In order for @GenerateView to work properly, the following requirements has to be fulfilled:

* The method must be named findBy[Property]. If a @TypeDiscriminator is defined, the "all" view used by the getAll method can also be generated.
* The method may only have one parameter.
* The property must exist in the target class.
+
__public String getColor()__ in the class Sofa the example above.
* For iterable properties the property may be named in the plural form: _List&lt;String&gt; getColors() _

The generated view will be named by_[property].

View generation is triggered by calling the method: _initStandardDesignDocument_ in __CouchDbRepositorySupport__.

If the standard design document doesn't exists, it will be created.

==== Resolving Field Name Conflicts

The database may contain other types of documents that have a field with the same name as in the type handled by a particular repository.
This is normally not a problem, but if that field name is used as a key or in a condition in a view, wrong documents may be returned in view queries.

In order to distinguish your type's documents in the database the @TypeDiscriminator annotation can be used:
[source,java]</pre>
</div>
</div>
<div class="paragraph">
<p>public class BlogPost {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@JsonProperty("_id")
private String id;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@JsonProperty("_rev")
private String rev;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>// this field marks blog post documents in the db
@TypeDiscriminator
private String title;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>            ...
---- It is also possible to write a custom type discriminator by declaring the @TypeDiscriminator on the type:</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">// the declared string is inserted as a part of if statements int the</span>
            generated view<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">s map function.
            @TypeDiscriminator(&quot;doc.title &amp;&amp; doc.myField === </span><span style="color:#710">'</span></span>special_value<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">&quot;)
            public class BlogPost {

            @JsonProperty(&quot;_id&quot;)
            private String id;

            @JsonProperty(&quot;_rev&quot;)
            private String rev

            private String title;

            private String myField;

            ...</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="additional_design_document_functions">5.5. Additional Design Document Functions</h3>
<div class="paragraph">
<p>Repositories based on CouchDbRepositorySupport may also define list, show and filter functions through annotations in the repository class.</p>
</div>
<div class="paragraph">
<p>They all have the same functionality, it is just the type of function that differs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Filter</span>( name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_filter</span><span style="color:#710">&quot;</span></span> file = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_filter.js</span><span style="color:#710">&quot;</span></span>)
        <span style="color:#007">@ListFunction</span>( name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_list_function</span><span style="color:#710">&quot;</span></span> file = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_list_function.js</span><span style="color:#710">&quot;</span></span>)
        <span style="color:#007">@ShowFunction</span>( name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_show_function</span><span style="color:#710">&quot;</span></span> file = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_show_function.js</span><span style="color:#710">&quot;</span></span>)
        <span style="color:#007">@UpdateHandler</span>( name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_show_function</span><span style="color:#710">&quot;</span></span> file = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">my_update_handler.js</span><span style="color:#710">&quot;</span></span>)
        <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyRepository</span> {
        ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple functions can be grouped with the corresponding annotations @Filters, @Lists, @Shows and @UpdateHandlers.</p>
</div>
<div class="paragraph">
<p>These annotations behaves in effect as the @View and @Views annotations described in section 3 of this chapter.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="attachments">6. Attachments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Documents in CouchDB may have any number of attachments associated with it.
The content of an attachment is not loaded together with the document, just a stub containing meta information is co-loaded with the document.</p>
</div>
<div class="sect2">
<h3 id="in_line_attachments">6.1. In-line Attachments</h3>
<div class="paragraph">
<p>Attachments can be stored along with its parent document by embedding them in the parent document.
The attachment itself has to be Base64 encoded in this case as the whole document including the attachment will be serialized into a string.</p>
</div>
<div class="paragraph">
<p>Note that the Sofa class in the example below extends CouchDbDocument and exposes the protected method addInlineAttachment(Attachment a).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">String</span> base64EncodedData = ...
        Sofa sofa = ...

        Attachment inline = <span style="color:#080;font-weight:bold">new</span> Attachment(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">attachment_id</span><span style="color:#710">&quot;</span></span>, base64EncodedData, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">image/jpeg</span><span style="color:#710">&quot;</span></span>);

        sofa.addInlineAttachment(inline);
        db.update(sofa);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create_document_and_attachment_in_one_operation">6.2. Create Document and Attachment in one operation</h3>
<div class="paragraph">
<p>An attachment and its parent document can be created in the same operation.
This is useful if you just want to store the data "as is" and don&#8217;t really use the actual document, i.e.
when storing an image.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">InputStream</span> data = ...
        String contentType = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">image/jpeg</span><span style="color:#710">&quot;</span></span>;

        AttachmentInputStream a = <span style="color:#080;font-weight:bold">new</span> AttachmentInputStream(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">attachment_id</span><span style="color:#710">&quot;</span></span>,
        data,
        contentType);

        db.createAttachment(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">new_document_id</span><span style="color:#710">&quot;</span></span>, a);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="add_an_attachment_to_an_existing_document">6.3. Add an Attachment to an Existing Document</h3>
<div class="paragraph">
<p>If you don&#8217;t want to add the attachment in-line, you can add attachments in an separate operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AttachmentInputStream a = <span style="color:#080;font-weight:bold">new</span>
        AttachmentInputStream(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">attachment_id</span><span style="color:#710">&quot;</span></span>,
        data,
        contentType);

        db.createAttachment(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">existing_document_id</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">document_revision</span><span style="color:#710">&quot;</span></span>, a);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fetch_an_attachment">6.4. Fetch an Attachment</h3>
<div class="paragraph">
<p>To retrieve the attachment&#8217;s content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AttachmentInputStream data = db.getAttachment(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">document_id</span><span style="color:#710">&quot;</span></span>,
        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">attachment_id</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The entity base class <em>org.ektorp.support.CouchDbDocument</em> provides an accessor for the document&#8217;s attachments.
The list contains stub attachments.</p>
</div>
</div>
<div class="sect2">
<h3 id="upload_a_document_with_attachments_in_mime_format">6.5. Upload a Document with Attachments in MIME Format</h3>
<div class="paragraph">
<p>Couch supports updating a document along with attachments as a MIME multipart/related message.
This is an efficient way to update a document along with attachments since it does not require Base64 encoding.</p>
</div>
<div class="paragraph">
<p>To update a document as a MIME multipart/related in Ektorp, use the updateMultipart() method of CouchDbConnector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span style="color:#0a8;font-weight:bold">File</span> file = someMethodToGetFile();
        <span style="color:#0a8;font-weight:bold">InputStream</span> mimeInputStream = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">FileInputStream</span>(file);
        db.updateMultipart(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">document_id</span><span style="color:#710">&quot;</span></span>,
        mimeInputStream,
        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">abc_boundary</span><span style="color:#710">&quot;</span></span>,
        file.length(),
        <span style="color:#080;font-weight:bold">new</span> Options());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data in the InputStream must contain only the MIME multipart/related message.
This message is specifed in <a href="http://wiki.apache.org/couchdb/HTTP_Document_API#Multiple_Attachments">
          CouchDB Multiple Attachments API
        </a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="querying">7. Querying</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Queries in Ektorp are always performed against predefined views in CouchDB.
View queries are issued through <em>org.ektorp.ViewQuery</em> objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ViewQuery query = <span style="color:#080;font-weight:bold">new</span> ViewQuery()
      .designDocId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_design/Sofa</span><span style="color:#710">&quot;</span></span>)
      .viewName(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">by_color</span><span style="color:#710">&quot;</span></span>)
      .key(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">red</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="query_for_objects">7.1. Query for Objects</h3>
<div class="paragraph">
<p>Objects can be loaded directly from view results as long as the result contain documents.
The document can either be included in the view result by specifying the query parameter <em>includeDocs(true)</em> or be emitted directly by the view into the value field.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ViewQuery query = <span style="color:#080;font-weight:bold">new</span> ViewQuery()
        .designDocId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_design/Sofa</span><span style="color:#710">&quot;</span></span>)
        .viewName(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">by_color</span><span style="color:#710">&quot;</span></span>)
        .key(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">red</span><span style="color:#710">&quot;</span></span>);

        <span style="color:#0a8;font-weight:bold">List</span>&lt;Sofa&gt; redSofas = db.queryView(query, Sofa.class);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scalar_queries">7.2. Scalar Queries</h3>
<div class="paragraph">
<p>It is possible to query for scalar values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ViewQuery query = <span style="color:#080;font-weight:bold">new</span> ViewQuery()
        .designDocId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_design/somedoc</span><span style="color:#710">&quot;</span></span>)
        .viewName(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">some_view_name</span><span style="color:#710">&quot;</span></span>);

        ViewResult result = db.queryView(query);
        <span style="color:#080;font-weight:bold">for</span> (ViewResult.Row row : result.getRows()) {
        <span style="color:#0a8;font-weight:bold">String</span> stringValue = row.getValue();
        <span style="color:#339;font-weight:bold">int</span> intValue = row.getValueAsInt();
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The key, value and doc fields can be access as a <em>org.jackson.JsonNode:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">          ViewResult result = db.queryView(query);
          <span style="color:#080;font-weight:bold">for</span> (ViewResult.Row row : result) {
          JsonNode keyNode = row.getKeyAsNode();
          JsonNode valueNode = row.getValueAsNode();
          JsonNode docNode = row.getDocAsNode();
          ...
          }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="view_result_as_raw_json_stream">7.3. View Result as Raw JSON Stream</h3>
<div class="paragraph">
<p>The most flexible method is query for stream.
The result is returned as a stream.
It is important that the stream is closed after usage as resource leaks otherwise will occur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ViewQuery query = <span style="color:#080;font-weight:bold">new</span> ViewQuery()
        .designDocId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_design/somedoc</span><span style="color:#710">&quot;</span></span>)
        .viewName(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">view_with_huge_result</span><span style="color:#710">&quot;</span></span>);

        <span style="color:#0a8;font-weight:bold">InputStream</span> data = db.queryForStream(query);
        ...
        data.close();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="complex_keys">7.4. Complex Keys</h3>
<div class="paragraph">
<p>If your views produce complex keys such as [2010, 6, 1], you should construct your key through the class <em>org.ektorp.ComplexKey</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ComplexKey start = ComplexKey.of(<span style="color:#00D">2010</span>, <span style="color:#00D">6</span>, <span style="color:#00D">1</span>);
          ComplexKey end = ComplexKey.of(<span style="color:#00D">2010</span>, <span style="color:#00D">10</span>, <span style="color:#00D">1</span>);

          ViewQuery query = <span style="color:#080;font-weight:bold">new</span> ViewQuery()
          .designDocId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_design/Order</span><span style="color:#710">&quot;</span></span>)
          .viewName(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">by_orderDate</span><span style="color:#710">&quot;</span></span>)
          .startKey(start)
          .endKey(end);
----If you want to use a wild card in your key, often used in date ranges, add a __ComplexKey.emptyObject()__:

[source,java]</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>ComplexKey allOf2010 = ComplexKey.of(2010, ComplexKey.emptyObject());</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>=== Pagination

CouchDbConnector provides a method for querying views for paged results.
The implementation is based on the recipe described in the book http://guide.couchdb.org/editions/1/en/recipes.html#pagination["CouchDB
          The Definitive Guide"
        ]

Querying a view for a page starts with the querying for the first page:
[source,java]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>PageRequest pageRequest = PageRequest.firstPage(5);</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>ViewQuery query = new ViewQuery()
.designDocId("_design/Order")
.viewName("by_orderDate")
.includeDocs(true);</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Page&lt;Order&gt; result = db.queryForPage(query, pageRequest, Order.class);</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>          // Page is iterable
          for (Order o : result) {
          // do something here
          }
----[parameter]``Requesting the next page is a simple
          affair: ``</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Page&lt;Order&gt; previousPage = ...
        PageRequest nextPageRequest = previousPage.getNextPageRequest();

        Page&lt;Order&gt; nextPage = db.queryForPage(query, nextPageRequest, Order.class);

        <span style="color:#777">// requesting the previous page:</span>
        PageRequest prevPageRequest = nextPage.getPreviousPageRequest();</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="pagerequest_as_a_text_link">7.4.1. PageRequest as a text link</h4>
<div class="paragraph">
<p>In order to simplify state handling between separate http requests the page request can be serialized into an URL-safe string.</p>
</div>
<div class="paragraph">
<p>Given that the Page object is available in the model in the jsp page below, a link to the previous page can be constructed like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span style="color:#070;font-weight:bold">&lt;c:if</span> <span style="color:#b48">test</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">${page.hasPrevious}</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
          <span style="color:#070;font-weight:bold">&lt;a</span> <span style="color:#b48">href</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/blog/posts/?p=${page.previousLink}</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>Previous page<span style="color:#070;font-weight:bold">&lt;/a&gt;</span>
          <span style="color:#070;font-weight:bold">&lt;/c:if&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the request is handled in a controller the page request can be recreated from the request parameter.
Here is an example snippet from a controller created in Spring MVC</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RequestMapping</span>( value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/</span><span style="color:#710">&quot;</span></span>, method =
          RequestMethod.GET)
          <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> viewAll(Model m, <span style="color:#007">@RequestParam</span>(value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">p</span><span style="color:#710">&quot;</span></span>, required = <span style="color:#069">false</span>) <span style="color:#0a8;font-weight:bold">String</span>
          pageLink) {
          PageRequest pr = pageLink != <span style="color:#069">null</span> ? PageRequest.fromLink(pageLink) :
          PageRequest.firstPage(<span style="color:#00D">5</span>);
          m.addAttribute(blogPostRepo.getAll(pr));
          <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/index</span><span style="color:#710">&quot;</span></span>;
          }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Handlig the page state as text links eliminates the need for storing data in the session.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="queries_and_cache">7.5. Queries and Cache</h3>
<div class="paragraph">
<p>If you enable the cache in a query, the result may be stale depending on how your view is constructed.</p>
</div>
<div class="paragraph">
<p>The cache works through conditional gets that invalidates the cache if the view&#8217;s etag has changed.
It is possible that an document update don&#8217;t cause the view contents to be updated and hence the cache will not be invalidated.
If you emit a timestamp or the document&#8217;s revision as the view value the cache will be properly invalidated.</p>
</div>
<div class="sect3">
<h4 id="enable_the_cached_queries">7.5.1. Enable the Cached Queries</h4>
<div class="paragraph">
<p>As of Ektorp 1.2.2 it is possible to control if a query should use the cache or not.
Cached queries is disabled by default but can be enabled by setting the parameter cacheOk to true in ViewQuery.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="change_notifications">8. Change Notifications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As of Ektorp 1.1.0 the <a href="http://wiki.apache.org/couchdb/HTTP_database_API#Changes">CouchDB
      changes API
    </a> is supported.</p>
</div>
<div class="paragraph">
<p>Ektorp provides two different methods to access the database changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Continuous changes feed enables your application to listen to change events as they happen in the database in real time.</p>
</li>
<li>
<p>Snapshots that provides all changes since a specific database sequence number.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both methods are specified through a ChangesCommand:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ChangesCommand cmd = <span style="color:#080;font-weight:bold">new</span> ChangesCommand.Builder()
      .includeDocs(<span style="color:#069">true</span>)
      .build();</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="continuous_changes">8.1. Continuous changes</h3>
<div class="paragraph">
<p>Ektorp provides a continuous changes feed through the class <em>org.ektorp.changes.ChangesFeed</em>.
The ChangesFeed provides an API that is similar to a BlockingQueue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ChangesCommand cmd = <span style="color:#080;font-weight:bold">new</span> ChangesCommand.Builder().build();

        ChangesFeed feed = db.changesFeed(cmd);

        <span style="color:#080;font-weight:bold">while</span> (feed.isAlive()) {
        DocumentChange change = feed.next();
        <span style="color:#0a8;font-weight:bold">String</span> docId = change.getId();
        ...
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t want to wait indefinitely for changes the ChangesFeed class provides a variant if the feed method where a time out can be specified.</p>
</div>
<div class="sect3">
<h4 id="managing_the_feed">8.1.1. Managing the Feed</h4>
<div class="paragraph">
<p>As long as the feed is alive it will continue to buffer changes coming from the database.
This will happen regardless if any thread is draing the feed though calls to next(). This means that your application might experience OutOfMemoryError if a feed is left unattended.</p>
</div>
<div class="paragraph">
<p>To kill a feed just call the cancel() method provided by the ChangesFeed class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="snapshots_2">8.2. Snapshots</h3>
<div class="paragraph">
<p>If continuous notifications are not needed, the database can be queried through the <em>changes</em> method in CouchDbConnector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">int</span> dbSequenceNumber = ... <span style="color:#777">// is available in the class</span>
        org.ektorp.DbInfo obtained through db.getDbInfo();

        ChangesCommand cmd = <span style="color:#080;font-weight:bold">new</span> ChangesCommand.Builder()
        .since(dbSequenceNumber)
        .build();

        <span style="color:#0a8;font-weight:bold">List</span>&lt;DocumentChange&gt; changes = db.changes(cmd);
        <span style="color:#080;font-weight:bold">for</span>(DocumentChange change : changes) {
        ...
        }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="calling_update_handlers">9. Calling Update Handlers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CouchDB provides the ability to define functions that clients can request to invoke server-side logic that will create or update a document.</p>
</div>
<div class="paragraph">
<p>CouchDbConnector provides a method for calling update handlers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CouchDbConnector db = ...
        String responseString = db.callUpdateHandler(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">_design/designDocID</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">functionName</span><span style="color:#710">&quot;</span></span>,
        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">docID</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="admin_functions">10. Admin Functions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="database_replication">10.1. Database Replication</h3>
<div class="paragraph">
<p>Database replication can be initiated through in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The replicate method in <em>CouchDbInstance.</em></p>
</li>
<li>
<p>The replicateTo and replicateFrom methods in <em>CouchDbConnector.</em></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="initiate_replication_from_couchdbinstance">10.1.1. Initiate Replication from CouchDbInstance</h4>
<div class="paragraph">
<p>The replication job is defined in the class <em>org.ektorp.ReplicationCommand</em>.
The command is created by its companion builder class: <em>org.ektorp.ReplicationCommand.Builder</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CouchDbInstance dbInstance = ...

          ReplicationCommand cmd = <span style="color:#080;font-weight:bold">new</span> ReplicationCommand.Builder()
          .source(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">example-database</span><span style="color:#710">&quot;</span></span>)
          .target(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://example.org/example-database</span><span style="color:#710">&quot;</span></span>)
          .build();

          ReplicationStatus status = dbInstance.replicate(cmd);</code></pre>
</div>
</div>
<div class="paragraph">
<p>ReplicationCommand supports all replication parameters defined in the <a href="http://wiki.apache.org/couchdb/Replication">CouchDb
            reference documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="initiate_replication_from_couchdbconnector">10.1.2. Initiate Replication from CouchDbConnector</h4>
<div class="paragraph">
<p>Replications can be initiated from a <em>CouchDbConnector</em>, in this case one database involved in the replication is the database the <em>CouchDbConnector</em> is connected to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CouchDbConnector db = ...

          ReplicationStatus status = db.replicateFrom(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">example-database</span><span style="color:#710">&quot;</span></span>);

          <span style="color:#777">// or</span>

          ReplicationStatus status2 = db.replicateTo(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://example.org/example-database</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The methods in <em>CouchDbConnector</em> will start basic one time replications, for more advanced options use the replicate method in <em>CouchDbInstance</em>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring_integration">11. Spring Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="xml_schema_based_configuration">11.1. XML Schema-based configuration</h3>
<div class="paragraph">
<p>Ektorp Spring module comes with a Spring XML namespace that simplifies the Ektorp configuration in an application context.</p>
</div>
<div class="paragraph">
<p>The following xml-snippet will create an CouchDbConnector connected to the database named "myDatabase". If an id is not declared the connector will be registered with the same id as the database name in the application context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#579">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;beans</span> <span style="color:#b48">xmlns</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/beans</span><span style="color:#710">&quot;</span></span>
        <span style="color:#b48">xmlns:xsi</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.w3.org/2001/XMLSchema-instance</span><span style="color:#710">&quot;</span></span>
        <span style="color:#b48">xmlns:couchdb</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.ektorp.org/schema/couchdb</span><span style="color:#710">&quot;</span></span>
        <span style="color:#b48">xsi:schemaLocation</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/beans</span>
        <span style="color:#D20">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
        <span style="color:#D20">http://www.ektorp.org/schema/couchdb http://www.ektorp.org/schema/couchdb/couchdb.xsd</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>

        <span style="color:#070;font-weight:bold">&lt;couchdb:database</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">myDatabase</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">url</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://localhost:5984</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

        <span style="color:#070;font-weight:bold">&lt;/beans&gt;</span>
----If you need multiple connectors connected to the same CouchDB instance, the CouchDbInstance bean can be explicitly declared:
[source,xml]</code></pre>
</div>
</div>
<div class="paragraph">
<p>&lt;beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:couchdb="http://www.ektorp.org/schema/couchdb"
          xsi:schemaLocation="http://www.springframework.org/schema/beans
          <a href="http://www.springframework.org/schema/beans/spring-beans-3.0.xsd" class="bare">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</a>
          <a href="http://www.ektorp.org/schema/couchdb" class="bare">http://www.ektorp.org/schema/couchdb</a> <a href="http://www.ektorp.org/schema/couchdb/couchdb.xsd"&gt" class="bare">http://www.ektorp.org/schema/couchdb/couchdb.xsd"&gt</a>;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;couchdb:instance id="localCouchDB" url="http://localhost:5984/" /&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;couchdb:database name="myDatabase" instance-ref="localCouchDB" /&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;couchdb:database name="myOtherDatabase" instance-ref="localCouchDB" /&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>          &lt;/beans&gt;
----[parameter]``If you need to specify more
          properties to Ektorp you can just refer to them when the CouchDB
          instance is declared: ``</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;beans</span> <span style="color:#b48">xmlns</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/beans</span><span style="color:#710">&quot;</span></span>
          <span style="color:#b48">xmlns:xsi</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.w3.org/2001/XMLSchema-instance</span><span style="color:#710">&quot;</span></span>
          <span style="color:#b48">xmlns:couchdb</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.ektorp.org/schema/couchdb</span><span style="color:#710">&quot;</span></span>
          <span style="color:#b48">xmlns:util</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/util</span><span style="color:#710">&quot;</span></span>
          <span style="color:#b48">xsi:schemaLocation</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/beans</span>
          <span style="color:#D20">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
          <span style="color:#D20">http://www.ektorp.org/schema/couchdb http://www.ektorp.org/schema/couchdb/couchdb.xsd</span>
          <span style="color:#D20">http://www.springframework.org/schema/util</span>
          <span style="color:#D20">http://www.springframework.org/schema/util/spring-util-3.0.xsd</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>

          <span style="color:#070;font-weight:bold">&lt;util:properties</span> <span style="color:#b48">id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">couchdbProperties</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">location</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">classpath:/couchdb.properties</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

          <span style="color:#070;font-weight:bold">&lt;couchdb:instance</span> <span style="color:#b48">id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">localCouchDB</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">url</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://localhost:5984</span><span style="color:#710">&quot;</span></span>
          <span style="color:#b48">properties</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">couchdbProperties</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>

          <span style="color:#070;font-weight:bold">&lt;couchdb:database</span> <span style="color:#b48">name</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">myDatabase</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">instance-ref</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">localCouchDB</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>

          <span style="color:#070;font-weight:bold">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="httpclientfactorybean">11.2. HttpClientFactoryBean</h3>
<div class="paragraph">
<p>If you for some reason cannot use the XML namespace described in the previous section, you can use the class org.ektorp.spring.HttpClientFactoryBean to configure a HttpClient in the application context.</p>
</div>
<div class="paragraph">
<p>When added to the appllication context, the factory will read configuration from couchdbProperties defined in the application context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
        &lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:util="http://www.springframework.org/schema/util"
        xmlns:context="http://www.springframework.org/schema/context"
        xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/util
        http://www.springframework.org/schema/util/spring-util-3.0.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd"&gt;

        &lt;util:properties id="couchdbProperties" location="classpath:/couchdb.properties"/&gt;

        &lt;bean id="httpClient" class="org.ektorp.spring.HttpClientFactoryBean" &gt;
        &lt;property name="properties" ref="couchdbProperties"/&gt;
        &lt;/bean&gt;

        &lt;bean id="couchDbInstance" class="org.ektorp.impl.StdCouchDbInstance"&gt;
        &lt;constructor-arg ref="httpClient"/&gt;
        &lt;/bean&gt;

        &lt;bean id="initialDataLoader" class="org.ektorp.spring.InitialDataLoader"
        autowire="byType" init-method="loadData"/&gt;

        &lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is a couchdb.properties to cut &amp; paste:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>host=localhost
        port=5984
        maxConnections=20
        connectionTimeout=1000
        socketTimeout=10000
        username=CouchDB_Admin
        password=geheimnis</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bootstrapping_the_database">11.3. Bootstrapping the Database</h3>
<div class="paragraph">
<p>The Ektorp Spring module features a class for loading the database with documents at application startup.</p>
</div>
<div class="paragraph">
<p>The <em>org.ektorp.spring.InitialDataLoader</em> will lookup all beans in the application context that implements <em>org.ektorp.dataload.DataLoader</em> (typically your repositories) and feed them data streams loaded from locations specified by the DataLoaders themselves.</p>
</div>
<div class="sect3">
<h4 id="declaring_the_initialdataloader_in_the_applicationcontext">11.3.1. Declaring the InitialDataLoader in the ApplicationContext</h4>
<div class="paragraph">
<p>The InitialDataLoader work best if its dependencies are autowired.
(Otherwise you will have to maintain the list of DataLoaders manually).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;bean</span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.ektorp.spring.InitialDataLoader</span><span style="color:#710">&quot;</span></span>
          <span style="color:#b48">autowire</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">constructor</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="component_scanning">11.3.2. Component Scanning</h4>
<div class="paragraph">
<p>The InitialDataLoader will be created automatically if you include the <em>org.ektorp.spring</em> package in your component scan directive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;context:component-scan base-package="org.example"&gt;
          &lt;context:include-filter type="regex" expression="org\.ektorp\.spring.*"/&gt;
          &lt;/context:component-scan&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dataloader">11.3.3. DataLoader</h4>
<div class="paragraph">
<p>The dataloader points out its data locations through the method String[] getDataLocations(). The location is loaded though Spring&#8217;s <a href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/resources.html">
            resource
            loader
          </a> so paths like <em>"classpath:/my_initial_docs.json"</em> are expected.
The DataLoader can then process the data in the loadInitialData method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.dataload</span>.*;
          <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.support</span>.*;

          <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">SofaRepository</span> <span style="color:#088;font-weight:bold">extends</span> CouchDbRepositorySupport&lt;Sofa&gt; <span style="color:#088;font-weight:bold">implements</span> DataLoader {

          <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> INITIAL_DATA_PATH = {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">classpath:/init_sofa_data.json</span><span style="color:#710">&quot;</span></span>};

          <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> loadInitialData(<span style="color:#0a8;font-weight:bold">Reader</span> in) {
          <span style="color:#080;font-weight:bold">new</span> DefaultDataLoader(db).load(in);
          }

          <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> getDataLocations() {
          <span style="color:#080;font-weight:bold">return</span> INITIAL_DATA_PATH;
          }

          <span style="color:#777">/**
          * Is called when all DataLoaders in the system has loaded it´s data.
          */</span>
          <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> allDataLoaded() {

          }
          }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="android_integration">12. Android Integration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Android Integration package provides additional functionality to improve the behavior of Ektorp on the Android Platform.
Using the AndroidHttpClient implementation is required since Android inclues a version of Apache HttpClient that is not compatible with the StdHttpClient provided by Ektorp.
Use of the other classes in this package is entirely optional, but they may save you writing repetitive code.</p>
</div>
<div class="sect2">
<h3 id="androidhttpclient">12.1. AndroidHttpClient</h3>
<div class="paragraph">
<p>Ektorp has a custom implementation of the HttpClient interface for Android <em>org.ektorp.android.http.AndroidHttpClient</em>.
It is designed to use the version of Apache HttpClient included in the Android platform: <em>AnddroidHttpClient.Builder</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">HttpClient authenticatedHttpClient = <span style="color:#080;font-weight:bold">new</span> AndroidHttpClient.Builder()
          .url(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://mychouchdbhost:5984</span><span style="color:#710">&quot;</span></span>)
          .username(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">admin</span><span style="color:#710">&quot;</span></span>)
          .password(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">secret</span><span style="color:#710">&quot;</span></span>)
          .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using AndroidHttpClient you should NOT include the httpclient or httpcore libraries in your project.
Android includes a copy of Apache HttpClient and supplying your own copy can lead to difficult to debug class loading exceptions.</p>
</div>
<div class="paragraph">
<p><em>NOTE:</em> AndroidHttpClient does not support caching.</p>
</div>
</div>
<div class="sect2">
<h3 id="ektorpasynctask">12.2. EktorpAsyncTask</h3>
<div class="paragraph">
<p>The EktorpAsyncTask class extends the Android platform&#8217;s <a href="http://developer.android.com/reference/android/os/AsyncTask.html">AsyncTask
        </a> class to perform Ektorp operations on a background thread, while handling success and failure conditions on the application&#8217;s main thread.
This is important since performing network operations on the main thread may lead to <a href="http://developer.android.com/reference/android/os/NetworkOnMainThreadException.html">
          NetworkOnMainThreadException</a>.
Further, you can only interact with the Android UI from the main thread.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EktorpAsyncTask createItemTask = <span style="color:#080;font-weight:bold">new</span> EktorpAsyncTask() {

      <span style="color:#007">@Override</span>
      <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> doInBackground() {
      couchDbConnector.create(item);
      }

      <span style="color:#007">@Override</span>
      <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> onSuccess() {
      Toast.makeText(context, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Document created successfully</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">5000</span>).show();
      }

      <span style="color:#007">@Override</span>
      <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> onUpdateConflict(UpdateConflictException updateConflictException) {
      Toast.makeText(context, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Got an update conflict for: </span><span style="color:#710">&quot;</span></span> + item.toString(), <span style="color:#00D">5000</span>).show();
      }

      <span style="color:#007">@Override</span>
      <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> onDbAccessException(DbAccessException dbAccessException) {
      Log.e(TAG, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">DbAccessException in background</span><span style="color:#710">&quot;</span></span>, dbAccessException);
      }
      };
      createItemTask.execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, a document is created on a background thread.
If the document is created successfully or an update conflict occurs, the user is notifed by a Toast popup message.
If any other DbAccessException occurs the exception is sent to the Android Log.</p>
</div>
</div>
<div class="sect2">
<h3 id="changesfeedasynctask">12.3. ChangesFeedAsyncTask</h3>
<div class="paragraph">
<p>The ChangesFeedAsyncTask is another class extending the Android platform&#8217;s <a href="http://developer.android.com/reference/android/os/AsyncTask.html">AsyncTask
        </a> class.
This class allows you to follow a CouchDB changes feed in a background thread and receive the DocumentChange objects on the main thread.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ExampleChangesFeedAsyncTask</span> <span style="color:#088;font-weight:bold">extends</span>
        ChangesFeedAsyncTask {

        <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Context</span> context;

        <span style="color:#088;font-weight:bold">public</span> ExampleChangesFeedAsyncTask(<span style="color:#0a8;font-weight:bold">Context</span> context, CouchDbConnector couchDbConnector,
        ChangesCommand changesCommand) {
        <span style="color:#950">super</span>(couchDbConnector, changesCommand);
        <span style="color:#950">this</span>.context = context;
        }

        <span style="color:#007">@Override</span>
        <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> handleDocumentChange(DocumentChange change) {
        Toast.makeText(context, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Received change sequence : </span><span style="color:#710">&quot;</span></span> + change.getSequence(), <span style="color:#00D">5000</span>).show();
        }

        <span style="color:#007">@Override</span>
        <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> onDbAccessException(DbAccessException dbAccessException) {
        Log.e(TAG, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">DbAccessException following changes feed</span><span style="color:#710">&quot;</span></span>, dbAccessException);
        }

        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then to use this class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ChangesCommand changesCmd = <span style="color:#080;font-weight:bold">new</span>
        ChangesCommand.Builder().since(lastUpdate).continuous(<span style="color:#069">true</span>).build();
        ExampleChangesFeedAsyncTask couchChangesAsyncTask = <span style="color:#080;font-weight:bold">new</span>
        ExampleChangesFeedAsyncTask(couchDbConnector, changesCmd);
        couchChangesAsyncTask.execute();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="couchbaseviewlistadapter">12.4. CouchbaseViewListAdapter</h3>
<div class="paragraph">
<p>The CouchbaseViewListAdapter class extends the Android platform&#8217;s <a href="http://developer.android.com/reference/android/widget/BaseAdapter.html">
          BaseAdapter
        </a> class.
This class allows you populate the rows of an Android <a href="http://developer.android.com/reference/android/widget/ListView.html">
          ListView</a>.
with content from the rows of a CouchDB view.
Optionally, you can have it follow the changes feed and update the list when the data changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ExampleListAdapter</span> <span style="color:#088;font-weight:bold">extends</span>
        CouchbaseViewListAdapter {

        <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Context</span> context;

        <span style="color:#088;font-weight:bold">public</span> ExampleListAdapter(<span style="color:#0a8;font-weight:bold">Context</span> context, CouchDbConnector couchDbConnector, ViewQuery
        viewQuery, <span style="color:#339;font-weight:bold">boolean</span> followChanges) {
        <span style="color:#950">super</span>(couchDbConnector, viewQuery, followChanges);
        <span style="color:#950">this</span>.context = context;
        }

        <span style="color:#007">@Override</span>
        <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">View</span> getView(<span style="color:#339;font-weight:bold">int</span> position, <span style="color:#0a8;font-weight:bold">View</span> itemView, ViewGroup parent) {
        <span style="color:#080;font-weight:bold">if</span> (itemView == <span style="color:#069">null</span>) {
        LayoutInflater li =
        (LayoutInflater)context.getSystemService(<span style="color:#0a8;font-weight:bold">Context</span>.LAYOUT_INFLATER_SERVICE);
        itemView = li.inflate(R.layout.grocery_list_item, <span style="color:#069">null</span>);
        }

        TextView label = (TextView) itemView.findViewById(R.id.label);
        Row row = getRow(position);
        JsonNode item = row.getValueAsNode();
        JsonNode itemText = item.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">text</span><span style="color:#710">&quot;</span></span>);
        <span style="color:#080;font-weight:bold">if</span>(itemText != <span style="color:#069">null</span>) {
        label.setText(itemText.getTextValue());
        }

        <span style="color:#080;font-weight:bold">return</span> itemView;
        }
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this adapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ViewQuery viewQuery = <span style="color:#080;font-weight:bold">new</span>
        ViewQuery().designDocId(dDocId).viewName(viewName);
        ExampleListAdapter itemListViewAdapter = <span style="color:#080;font-weight:bold">new</span> ExampleListAdapter(<span style="color:#950">this</span>, couchDbConnector,
        viewQuery, <span style="color:#069">true</span>);
        listView.setAdapter(itemListViewAdapter);</code></pre>
</div>
</div>
</div>
</div>
</div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2019..      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>