<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.1 from src/site/asciidoc/tutorial.adoc at 2019-10-15

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.1" />
    <title>Ektorp &#x2013; </title>
    <link rel="stylesheet" href="./css/maven-base.css" />
    <link rel="stylesheet" href="./css/maven-theme.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<div id="bannerLeft">Ektorp
</div>
<a href="https://github.com/triplem/Ektorp/tree/v1.6" id="bannerRight">Ektorp
</a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2019-10-15</span>
          &#xA0;| <span id="projectVersion">Version: 2.0.0-SNAPSHOT</span>
      </div>
      <div class="xright">      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Overview</h5>
    <ul>
     <li class="none"><a href="index.html" title="Introduction">Introduction</a></li>
     <li class="none"><a href="reference_doc.html" title="Reference Docs">Reference Docs</a></li>
     <li class="none"><strong>Tutorial</strong></li>
     <li class="none"><a href="https://sonarcloud.io/dashboard?id=triplem_Ektorp" class="externalLink" title="Sonar">Sonar</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="project-info.html" title="Project Information">Project Information</a></li>
     <li class="collapsed"><a href="project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>Relaxed Java Persistence with Ektorp and CouchDB</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#functionality">1.1. Functionality</a></li>
<li><a href="#prerequisite_software">1.2. Prerequisite Software</a></li>
<li><a href="#launching">1.3. Launching</a></li>
</ul>
</li>
<li><a href="#the_structure_of_the_application">2. The Structure of the Application</a>
<ul class="sectlevel2">
<li><a href="#object_model">2.1. Object Model</a></li>
<li><a href="#modeling_for_concurrency">2.2. Modeling for Concurrency</a></li>
<li><a href="#repositories">2.3. Repositories</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document gives a brief overview on how to develop a basic blog application using CouchDB and Ektorp for persistence and Spring MVC 3 for the web layer.</p>
</div>
<div class="sect2">
<h3 id="functionality">1.1. Functionality</h3>
<div class="paragraph">
<p>The Relaxed Blog sample web application is pretty basic, it has the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create blog posts</p>
</li>
<li>
<p>View a list of all blog posts</p>
</li>
<li>
<p>Create a comment for a blog post</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="prerequisite_software">1.2. Prerequisite Software</h3>
<div class="paragraph">
<p>You need to have the following software installed on your system in order to run the sample application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/downloads/helun/Ektorp/org.ektorp.sample-1.8-project.zip">org.ektorp.sample-1.8-project.zip </a></p>
</li>
<li>
<p>CouchDB installed and running.</p>
</li>
<li>
<p>Java SDK 1.8</p>
</li>
<li>
<p>Maven 3</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="launching">1.3. Launching</h3>
<div class="paragraph">
<p>Download the Relaxed Blog sample project and unpack the project somewhere nice.</p>
</div>
<div class="paragraph">
<p>Make sure you have CouchDB running locally.
If you want to specify couchdb connection parameters it can be done in the file /src/main/resources/couchdb.properties in the sample project.</p>
</div>
<div class="paragraph">
<p>From the project&#8217;s root, start the application by the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mvn jetty:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>Point your browser at <a href="http://localhost:8080/blog/posts/" class="bare">http://localhost:8080/blog/posts/</a> and you should find the first page of the Relaxed Blog application.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the_structure_of_the_application">2. The Structure of the Application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="object_model">2.1. Object Model</h3>
<div class="paragraph">
<p>This application has two "domain" classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>org.ektorp.sample.BlogPost</em></p>
</li>
<li>
<p><em>org.ektorp.sample.Comment</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For convenience, they both extend <em>org.ektorp.support.CouchDbDocument</em> (this is however not an requirement).</p>
</div>
<div class="paragraph">
<p>Both classes are classic Java Beans with good old getters and setters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">org.ektorp.sample</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">java.util</span>.*;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.support</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.joda.time</span>.*;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">BlogPost</span> <span style="color:#088;font-weight:bold">extends</span> CouchDbDocument {

<span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">long</span> serialVersionUID = <span style="color:#00D">1L</span>;
<span style="color:#777">/**
* @TypeDiscriminator is used to mark properties that makes this class's documents unique in
the database.
*/</span>
<span style="color:#007">@TypeDiscriminator</span>
<span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> title;

<span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> body;

<span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; tags;

<span style="color:#088;font-weight:bold">private</span> DateTime dateCreated;

<span style="color:#777">/**
* @DocumentReferences is used to refer to other documents in the database, in this case
comments.
*/</span>
<span style="color:#007">@DocumentReferences</span>(fetch = FetchType.LAZY, descendingSortOrder = <span style="color:#069">true</span>, orderBy =
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">dateCreated</span><span style="color:#710">&quot;</span></span>, backReference = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">blogPostId</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Comment&gt; comments;

  <span style="color:#088;font-weight:bold">public</span> DateTime getDateCreated() {
    <span style="color:#080;font-weight:bold">return</span> dateCreated;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setDateCreated(DateTime dateCreated) {
    <span style="color:#950">this</span>.dateCreated = dateCreated;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getTitle() {
    <span style="color:#080;font-weight:bold">return</span> title;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setTitle(<span style="color:#0a8;font-weight:bold">String</span> title) {
    <span style="color:#950">this</span>.title = title;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getBody() {
    <span style="color:#080;font-weight:bold">return</span> body;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setBody(<span style="color:#0a8;font-weight:bold">String</span> body) {
    <span style="color:#950">this</span>.body = body;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; getTags() {
    <span style="color:#080;font-weight:bold">return</span> tags;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setTags(<span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; tags) {
    <span style="color:#950">this</span>.tags = tags;
  }
}

<span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">org.ektorp.sample</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.support</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.joda.time</span>.*;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Comment</span> <span style="color:#088;font-weight:bold">extends</span> CouchDbDocument {

  <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">long</span> serialVersionUID = <span style="color:#00D">1L</span>;

  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> blogPostId;
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> comment;
  <span style="color:#088;font-weight:bold">private</span> DateTime dateCreated;
  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> email;

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getBlogPostId() {
    <span style="color:#080;font-weight:bold">return</span> blogPostId;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setBlogPostId(<span style="color:#0a8;font-weight:bold">String</span> blogPostId) {
    <span style="color:#950">this</span>.blogPostId = blogPostId;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getComment() {
    <span style="color:#080;font-weight:bold">return</span> comment;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setComment(<span style="color:#0a8;font-weight:bold">String</span> comment) {
    <span style="color:#950">this</span>.comment = comment;
  }

  <span style="color:#088;font-weight:bold">public</span> DateTime getDateCreated() {
    <span style="color:#080;font-weight:bold">return</span> dateCreated;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setDateCreated(DateTime dateCreated) {
    <span style="color:#950">this</span>.dateCreated = dateCreated;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getEmail() {
    <span style="color:#080;font-weight:bold">return</span> email;
  }

  <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setEmail(<span style="color:#0a8;font-weight:bold">String</span> username) {
    <span style="color:#950">this</span>.email = username;
  }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modeling_for_concurrency">2.2. Modeling for Concurrency</h3>
<div class="paragraph">
<p>The straight forward solution to modeling blog post comments is to model the comments as a list embedded in the blog post document.
Although this is almost always preferable, this model would in this case cause update congestion in the blog post document if many users post comments concurrently.</p>
</div>
<div class="paragraph">
<p>We choose instead to model comments as separate documents next to blog post documents.
The relationship between BlogPost and Comment is maintained through the blogPostId field in the Comment class.
The comments field in BlogPost is annotated with @DocumentReferences which enables Ektorp to load related comments to a blog post transparently and lazily.</p>
</div>
<div class="paragraph">
<p>Keeping each comment in its own document is a more efficient solution from a concurrency point of view is to as no update conflicts will occur.</p>
</div>
<div class="paragraph">
<p>What is the most appropriate model differs from case to case.
In general when the parent object and its children has a more uniform update cycle, it is best to embed the list contents in the parent document / object.</p>
</div>
</div>
<div class="sect2">
<h3 id="repositories">2.3. Repositories</h3>
<div class="paragraph">
<p>All interactions with the database are encapsulated within repositories.
A repository is typically responsible for a particlar domain class.</p>
</div>
<div class="paragraph">
<p>his application has two repositories, one for each domain class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>org.ektorp.sample.BlogPostRepository</em></p>
</li>
<li>
<p><em>org.ektorp.sample.CommentRepository</em></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="the_blogpostrepository">2.3.1. The BlogPostRepository</h4>
<div class="paragraph">
<p>This repository obviously handles blog posts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">org.ektorp.sample</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">java.util</span>.*;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.support</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.beans.factory.annotation</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.stereotype</span>.*;

<span style="color:#007">@Component</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">BlogPostRepository</span> <span style="color:#088;font-weight:bold">extends</span> CouchDbRepositorySupport&lt;BlogPost&gt; {

  <span style="color:#007">@Autowired</span>
  <span style="color:#088;font-weight:bold">public</span> BlogPostRepository(<span style="color:#007">@Qualifier</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">blogPostDatabase</span><span style="color:#710">&quot;</span></span>) CouchDbConnector db) {
    <span style="color:#950">super</span>(BlogPost.class, db);
    initStandardDesignDocument();
  }

  <span style="color:#007">@GenerateView</span> <span style="color:#007">@Override</span>
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;BlogPost&gt; getAll() {
    ViewQuery q = createQuery(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">all</span><span style="color:#710">&quot;</span></span>).descending(<span style="color:#069">true</span>);
    <span style="color:#080;font-weight:bold">return</span> db.queryView(q, BlogPost.class);
  }

  <span style="color:#007">@GenerateView</span>
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;BlogPost&gt; findByTag(<span style="color:#0a8;font-weight:bold">String</span> tag) {
    <span style="color:#080;font-weight:bold">return</span> queryView(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">by_tag</span><span style="color:#710">&quot;</span></span>, tag);
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>View definitions can be embedded within repositories through the @View annotation.</p>
</div>
<div class="sect4">
<h5 id="listing_all_blog_posts">Listing all Blog Posts</h5>
<div class="paragraph">
<p>The support class <em>CouchDbRepositorySupport</em> provides a getAll() method out of the box.
It calls the <em>all</em> view that has to be defined in the database and returns all documents handled by this repository.
In this case the <em>all</em> view can be automatically generated by Ektorp as the BlogPost class has defined a field with a @TypeDiscriminator annotation that gives Ektorp enough information so that the <em>all</em> view can be generated.</p>
</div>
<div class="paragraph">
<p>As we want the latest blog post to appear first, we have to override the default getAll() method and specify descending sort order.</p>
</div>
<div class="paragraph">
<p>The "all" view is defined in the @View annotation declared in the repository class above.
In order for the view to be sorted by date, dateCreated is emitted as key.</p>
</div>
<div class="paragraph">
<p>If you are new to CouchDB and Views you can read more <a href="http://guide.couchdb.org/editions/1/en/views.html">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="the_generateview_annotation">The @GenerateView annotation</h5>
<div class="paragraph">
<p>The findByTag method is not used in the sample application, but it is shown here as an example on how the @GenerateView annotation us used.</p>
</div>
<div class="paragraph">
<p>Finder methods annotated with @GenerateView will have their view definitions automatically created.</p>
</div>
</div>
<div class="sect4">
<h5 id="the_constructor">The Constructor</h5>
<div class="paragraph">
<p>The CouchDbConnector is autowired in the constructor by Spring framework.
As new connectors might be added to the applications later, a specific connector is specified through the @Qualifier("blogPostDatabase") annotation.</p>
</div>
<div class="paragraph">
<p>The constructor in the super class has to be called in order to specifiy this repository&#8217;s handled type (BlogPost.class) and to provide the CouchDbConnector reference to the underlying support code.</p>
</div>
<div class="paragraph">
<p>The constructor then calls the <em>initStandardDesignDocument()</em> method in order for the <em>@View</em> and <em>@GenerateView</em> definitions to be generated and inserted into the database.
Existing view definitions are not overwritten so if you change your definitions, you will have to delete the existing view (or design document) in the database.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the_commentrepository">2.3.2. The CommentRepository</h4>
<div class="paragraph">
<p>There isn&#8217;t much to say about the CommentRepository besides that the view used in findByBlogPostId uses the @GenerateView annotation in order to generate the view that describes the Comment&#8217;s relationship with the BlogPost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">org.ektorp.sample</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">java.util</span>.*;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.ektorp.support</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.beans.factory.annotation</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.stereotype</span>.*;

<span style="color:#007">@Component</span>
<span style="color:#007">@View</span>( name=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">all</span><span style="color:#710">&quot;</span></span>, map = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">function(doc) { if (doc.blogPostId) { emit(null, doc) } }</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CommentRepository</span> <span style="color:#088;font-weight:bold">extends</span> CouchDbRepositorySupport&lt;Comment&gt; {

  <span style="color:#007">@Autowired</span>
  <span style="color:#088;font-weight:bold">public</span> CommentRepository(<span style="color:#007">@Qualifier</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">blogPostDatabase</span><span style="color:#710">&quot;</span></span>) CouchDbConnector db) {
    <span style="color:#950">super</span>(Comment.class, db);
    initStandardDesignDocument();
  }

  <span style="color:#007">@GenerateView</span>
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;Comment&gt; findByBlogPostId(<span style="color:#0a8;font-weight:bold">String</span> blogPostId) {
    <span style="color:#080;font-weight:bold">return</span> queryView(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">by_blogPostId</span><span style="color:#710">&quot;</span></span>, blogPostId);
  }

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the_controller">2.3.3. The Controller</h4>
<div class="paragraph">
<p>The BlogController handles all use cases in this application.
As this is a very simple application there is no service layer and the controller uses the repositories directly.</p>
</div>
<div class="paragraph">
<p>Authorization and such is left as an exercise for you, the reader.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">org.ektorp.sample</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.joda.time</span>.*;
  <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.beans.factory.annotation</span>.*;
  <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.stereotype</span>.*;
  <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.ui</span>.*;
  <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.web.bind.annotation</span>.*;
  <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.web.servlet</span>.*;

<span style="color:#007">@Controller</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">BlogController</span> {

  <span style="color:#007">@Autowired</span>
  BlogPostRepository blogPostRepo;
  <span style="color:#007">@Autowired</span>
  CommentRepository commentRepo;

  <span style="color:#007">@RequestMapping</span>( value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/</span><span style="color:#710">&quot;</span></span>, method = RequestMethod.GET)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> viewAll(Model m) {
    m.addAttribute(blogPostRepo.getAll());
    <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/index</span><span style="color:#710">&quot;</span></span>;
  }

  <span style="color:#007">@RequestMapping</span>( value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/new</span><span style="color:#710">&quot;</span></span>, method = RequestMethod.GET)
  <span style="color:#088;font-weight:bold">public</span> ModelAndView newPost() {
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> ModelAndView(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/edit</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">command</span><span style="color:#710">&quot;</span></span>, <span style="color:#080;font-weight:bold">new</span> BlogPost());
  }

  <span style="color:#007">@RequestMapping</span>( value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/</span><span style="color:#710">&quot;</span></span>, method = RequestMethod.POST)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> submitPost(<span style="color:#007">@ModelAttribute</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">command</span><span style="color:#710">&quot;</span></span>) BlogPost post) {
    <span style="color:#080;font-weight:bold">if</span> (post.isNew()) {
      post.setId(createId(post.getTitle()));
      post.setDateCreated(<span style="color:#080;font-weight:bold">new</span> DateTime());
    }
    blogPostRepo.update(post);
    <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">redirect:/blog/posts/</span><span style="color:#710">&quot;</span></span>;
  }

  <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> createId(<span style="color:#0a8;font-weight:bold">String</span> title) {
    <span style="color:#080;font-weight:bold">return</span> title.replaceAll(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#b0b">\\</span><span style="color:#D20">s</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">-</span><span style="color:#710">&quot;</span></span>);
  }

  <span style="color:#007">@RequestMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/{postId}</span><span style="color:#710">&quot;</span></span>)
  <span style="color:#088;font-weight:bold">public</span> ModelAndView viewPost(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">postId</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">String</span> postId) {
    ModelAndView model = <span style="color:#080;font-weight:bold">new</span> ModelAndView(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/view</span><span style="color:#710">&quot;</span></span>);
    model.addObject(blogPostRepo.get(postId));
    model.addObject(commentRepo.findByBlogPostId(postId));
    <span style="color:#080;font-weight:bold">return</span> model;
  }

  <span style="color:#007">@RequestMapping</span>( value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/{postId}/edit</span><span style="color:#710">&quot;</span></span>, method = RequestMethod.GET)
  <span style="color:#088;font-weight:bold">public</span> BlogPost editPost(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">postId</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">String</span> postId) {
    <span style="color:#080;font-weight:bold">return</span> blogPostRepo.get(postId);
  }

  <span style="color:#007">@RequestMapping</span>( value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/posts/{postId}/comment</span><span style="color:#710">&quot;</span></span>, method = RequestMethod.POST)
  <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> addComment(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">postId</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">String</span> postId, <span style="color:#007">@ModelAttribute</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">command</span><span style="color:#710">&quot;</span></span>)
    Comment comment) {
    comment.setBlogPostId(postId);
    comment.setDateCreated(<span style="color:#080;font-weight:bold">new</span> DateTime());
    commentRepo.add(comment);
    <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">redirect:/blog/posts/</span><span style="color:#710">&quot;</span></span> + comment.getBlogPostId();
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the_spring_application_context">2.3.4. The Spring Application Context</h4>
<div class="paragraph">
<p>Almost all components in this application are configured through annotations.
The few things that need to be configured in xml are the <em>StdCouchDbConnector</em> and its supporting classes <em>StdCouchDbInstance</em> and <em>HttpClient</em>.</p>
</div>
<div class="paragraph">
<p>The HttpClient is created with the help of <em>org.ektorp.spring.HttpClientFactoryBean</em> that read configuration parameters from <em>couchdb.properties</em> defined below.</p>
</div>
<div class="paragraph">
<p>Note that in a bigger application, you would want <em>StdCouchDbInstance</em> to be a standalone bean so that it can be referenced by multiple <em>CouchDbConnectors</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#579">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
          <span style="color:#070;font-weight:bold">&lt;beans</span> <span style="color:#b48">xmlns</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/beans</span><span style="color:#710">&quot;</span></span>
          <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#b48">xmlns:xsi</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.w3.org/2001/XMLSchema-instance</span><span style="color:#710">&quot;</span></span>
          <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#b48">xmlns:context</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/context</span><span style="color:#710">&quot;</span></span>
          <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#b48">xmlns:util</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/util</span><span style="color:#710">&quot;</span></span>
          <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#F00;background-color:#FAA"> </span> <span style="color:#b48">xsi:schemaLocation</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.springframework.org/schema/beans</span>
          <span style="color:#D20">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
          <span style="color:#D20">                http://www.springframework.org/schema/util</span>
          <span style="color:#D20">http://www.springframework.org/schema/util/spring-util-3.0.xsd</span>
          <span style="color:#D20">                http://www.springframework.org/schema/context</span>
          <span style="color:#D20">http://www.springframework.org/schema/context/spring-context-3.0.xsd</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
                 
                  <span style="color:#777">&lt;!-- Scans within the base package of the application for @Components to
          configure as beans --&gt;</span>
                  <span style="color:#070;font-weight:bold">&lt;context:component-scan</span> <span style="color:#b48">base-package</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.ektorp.sample</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
                 
                  <span style="color:#070;font-weight:bold">&lt;util:properties</span> <span style="color:#b48">id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">couchdbProperties</span><span style="color:#710">&quot;</span></span>
          <span style="color:#b48">location</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">classpath:/couchdb.properties</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>

                  <span style="color:#070;font-weight:bold">&lt;bean</span> <span style="color:#b48">id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">blogPostDatabase</span><span style="color:#710">&quot;</span></span> <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.ektorp.impl.StdCouchDbConnector</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
                          <span style="color:#070;font-weight:bold">&lt;constructor-arg</span> <span style="color:#b48">value</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">blogPosts</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
                          <span style="color:#070;font-weight:bold">&lt;constructor-arg&gt;</span>
                                  <span style="color:#070;font-weight:bold">&lt;bean</span> <span style="color:#b48">id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">couchDbInstance</span><span style="color:#710">&quot;</span></span>
          <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.ektorp.impl.StdCouchDbInstance</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
                                          <span style="color:#070;font-weight:bold">&lt;constructor-arg&gt;</span>
                                                  <span style="color:#070;font-weight:bold">&lt;bean</span>
          <span style="color:#b48">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">org.ektorp.spring.HttpClientFactoryBean</span><span style="color:#710">&quot;</span></span> <span style="color:#070;font-weight:bold">/&gt;</span>
                                          <span style="color:#070;font-weight:bold">&lt;/constructor-arg&gt;</span>
                                  <span style="color:#070;font-weight:bold">&lt;/bean&gt;</span>
                          <span style="color:#070;font-weight:bold">&lt;/constructor-arg&gt;</span>
                  <span style="color:#070;font-weight:bold">&lt;/bean&gt;</span>
                 
          <span style="color:#070;font-weight:bold">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="in_the_database">2.3.5. In the Database</h4>
<div class="paragraph">
<p>If you successfully started the application, your CouchDb instance will contain a new database called blogposts.
The new database should contain one design documents: <em>\_design/BlogPost</em> the contains the auto generated views .</p>
</div>
<div class="paragraph">
<p>If you made any posts or comments you should find them here as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="conclusion">2.3.6. Conclusion</h4>
<div class="paragraph">
<p>Now we have covered what a simple application with Ektorp as persistence layer looks like and I hope you will find Ektorp useful for you.</p>
</div>
</div>
<div class="sect3">
<h4 id="further_reading">2.3.7. Further Reading</h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://blog.couch.io/post/595079631/document-modelling-rules-of-thumb"> Document Modelling Rules of Thumb </a></p>
</li>
<li>
<p><a href="https://helun.github.io/Ektorp/reference_documentation.html">Ektorp Reference Documentation </a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2019..      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>